<!doctype html>
<html>
    <head>
        <title>PnL Dashboard</title>
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <style>
            body {
                background-color: #f8f9fa;
            }
            .stats-card {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 10px;
                padding: 20px;
                text-align: center;
            }
            .positive {
                color: #28a745;
            }
            .negative {
                color: #dc3545;
            }
            .chart-container {
                background: white;
                border-radius: 10px;
                padding: 20px;
                margin-bottom: 20px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
        </style>
    </head>
    <body>
        <nav class="navbar navbar-dark bg-dark">
            <div class="container">
                <span class="navbar-brand">üìä PnL Dashboard</span>
                <a href="/" class="btn btn-outline-light btn-sm"
                    >New Analysis</a
                >
            </div>
        </nav>

        <div class="container mt-4">
            <div class="row mb-4">
                <div class="col-12">
                    <h2>Portfolio Performance</h2>
                    <small class="text-muted">
                        {{ user_address[:8] }}...{{ user_address[-6:] }} | {{
                        days_back }} days
                    </small>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-2">
                    <div class="stats-card">
                        <h6>Total PnL</h6>
                        <h4
                            class="{% if stats.total_pnl >= 0 %}positive{% else %}negative{% endif %}"
                        >
                            ${{ "{:,.2f}".format(stats.total_pnl) }}
                        </h4>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stats-card">
                        <h6>Avg Daily PnL</h6>
                        <h4
                            class="{% if stats.avg_daily_pnl >= 0 %}positive{% else %}negative{% endif %}"
                        >
                            ${{ "{:,.2f}".format(stats.avg_daily_pnl) }}
                        </h4>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stats-card">
                        <h6>Win Rate</h6>
                        <h4>{{ "{:.1f}%".format(stats.win_rate) }}</h4>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stats-card">
                        <h6>Max Drawdown</h6>
                        <h4 class="negative">
                            ${{ "{:,.2f}".format(stats.max_drawdown) }}
                        </h4>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stats-card">
                        <h6>Total Trades</h6>
                        <h4>{{ stats.total_trades }}</h4>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stats-card">
                        <h6>Profitable</h6>
                        <h4 class="positive">{{ stats.profitable_trades }}</h4>
                    </div>
                </div>
            </div>

            <!-- Portfolio PnL Chart -->
            <div class="row">
                <div class="col-12">
                    <div class="chart-container">
                        <div id="pnlChart"></div>
                    </div>
                </div>
            </div>

            <!-- BTC Dollar Comparison Chart -->
            <div class="row">
                <div class="col-12">
                    <div class="chart-container">
                        <div id="btcCompareChart"></div>
                    </div>
                </div>
            </div>

            <!-- Percentage Returns Comparison Chart -->
            <div class="row">
                <div class="col-12">
                    <div class="chart-container">
                        <div id="percentageChart"></div>
                    </div>
                </div>
            </div>

            <!-- Drawdown Comparison Chart -->
            <div class="row">
                <div class="col-12">
                    <div class="chart-container">
                        <div id="drawdownChart"></div>
                    </div>
                </div>
            </div>

            <!-- Comprehensive Trading Metrics Table -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="chart-container">
                        <h4 class="mb-3">üìä Detailed Trading Metrics</h4>
                        <div class="row">
                            <!-- Performance Metrics -->
                            <div class="col-md-4">
                                <h6 class="text-primary mb-3">
                                    üí∞ Performance Metrics
                                </h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td>Total Return</td>
                                        <td
                                            class="text-end fw-bold {% if stats.return_pct >= 0 %}text-success{% else %}text-danger{% endif %}"
                                        >
                                            {{
                                            "{:+.2f}%".format(stats.return_pct)
                                            }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Total P&L</td>
                                        <td
                                            class="text-end fw-bold {% if stats.total_pnl >= 0 %}text-success{% else %}text-danger{% endif %}"
                                        >
                                            ${{
                                            "{:,.2f}".format(stats.total_pnl) }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Largest Win</td>
                                        <td class="text-end text-success">
                                            ${{
                                            "{:,.2f}".format(stats.largest_win)
                                            }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Largest Loss</td>
                                        <td class="text-end text-danger">
                                            ${{
                                            "{:,.2f}".format(stats.largest_loss)
                                            }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Avg Win</td>
                                        <td class="text-end text-success">
                                            ${{ "{:,.2f}".format(stats.avg_win)
                                            }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Avg Loss</td>
                                        <td class="text-end text-danger">
                                            ${{ "{:,.2f}".format(stats.avg_loss)
                                            }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Profit Factor</td>
                                        <td
                                            class="text-end fw-bold {% if stats.profit_factor >= 1.5 %}text-success{% elif stats.profit_factor >= 1 %}text-warning{% else %}text-danger{% endif %}"
                                        >
                                            {{
                                            "{:.2f}".format(stats.profit_factor)
                                            }}
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <!-- Risk Metrics -->
                            <div class="col-md-4">
                                <h6 class="text-warning mb-3">
                                    ‚ö†Ô∏è Risk Metrics
                                </h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td>Max Drawdown</td>
                                        <td
                                            class="text-end fw-bold text-danger"
                                        >
                                            ${{
                                            "{:,.2f}".format(stats.max_drawdown)
                                            }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Sharpe Ratio (Portfolio)</td>
                                        <td
                                            class="text-end fw-bold {% if stats.sharpe_ratio >= 1 %}text-success{% elif stats.sharpe_ratio >= 0 %}text-warning{% else %}text-danger{% endif %}"
                                        >
                                            {{
                                            "{:.2f}".format(stats.sharpe_ratio)
                                            }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Sharpe Ratio (BTC)</td>
                                        <td
                                            class="text-end fw-bold {% if stats.btc_sharpe_ratio >= 1 %}text-success{% elif stats.btc_sharpe_ratio >= 0 %}text-warning{% else %}text-danger{% endif %}"
                                        >
                                            {{
                                            "{:.2f}".format(stats.btc_sharpe_ratio)
                                            }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Sharpe Advantage</td>
                                        <td
                                            class="text-end fw-bold {% if (stats.sharpe_ratio - stats.btc_sharpe_ratio) > 0 %}text-success{% elif (stats.sharpe_ratio - stats.btc_sharpe_ratio) < 0 %}text-danger{% else %}text-secondary{% endif %}"
                                        >
                                            {% if (stats.sharpe_ratio -
                                            stats.btc_sharpe_ratio) > 0 %} +{{
                                            "{:.2f}".format(stats.sharpe_ratio -
                                            stats.btc_sharpe_ratio) }} {% elif
                                            (stats.sharpe_ratio -
                                            stats.btc_sharpe_ratio) < 0 %} {{
                                            "{:.2f}".format(stats.sharpe_ratio -
                                            stats.btc_sharpe_ratio) }} {% else
                                            %} {{
                                            "{:.2f}".format(stats.sharpe_ratio -
                                            stats.btc_sharpe_ratio) }} {% endif
                                            %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Recovery Factor</td>
                                        <td
                                            class="text-end {% if stats.recovery_factor >= 2 %}text-success{% elif stats.recovery_factor >= 1 %}text-warning{% else %}text-danger{% endif %}"
                                        >
                                            {{
                                            "{:.2f}".format(stats.recovery_factor)
                                            }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Reward:Risk Ratio</td>
                                        <td
                                            class="text-end fw-bold {% if stats.reward_risk_ratio >= 2 %}text-success{% elif stats.reward_risk_ratio >= 1.5 %}text-warning{% else %}text-danger{% endif %}"
                                        >
                                            {{
                                            "{:.2f}:1".format(stats.reward_risk_ratio)
                                            }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Win Rate</td>
                                        <td
                                            class="text-end fw-bold {% if stats.win_rate >= 60 %}text-success{% elif stats.win_rate >= 40 %}text-warning{% else %}text-danger{% endif %}"
                                        >
                                            {{ "{:.1f}%".format(stats.win_rate)
                                            }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Max Consecutive Wins</td>
                                        <td class="text-end text-success">
                                            {{ stats.max_consecutive_wins }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Max Consecutive Losses</td>
                                        <td class="text-end text-danger">
                                            {{ stats.max_consecutive_losses }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Avg Daily P&L</td>
                                        <td
                                            class="text-end {% if stats.avg_daily_pnl >= 0 %}text-success{% else %}text-danger{% endif %}"
                                        >
                                            ${{
                                            "{:,.2f}".format(stats.avg_daily_pnl)
                                            }}
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <!-- Trading Activity -->
                            <div class="col-md-4">
                                <h6 class="text-info mb-3">
                                    üìà Trading Activity
                                </h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Strategy Start</strong></td>
                                        <td
                                            class="text-end fw-bold text-primary"
                                        >
                                            {{ stats.strategy_start_date }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>Strategy End</strong></td>
                                        <td
                                            class="text-end fw-bold text-primary"
                                        >
                                            {{ stats.strategy_end_date }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Trading Days</td>
                                        <td class="text-end">
                                            {{ stats.trading_days }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Total Trades</td>
                                        <td class="text-end fw-bold">
                                            {{ stats.total_trades }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Winning Trades</td>
                                        <td class="text-end text-success">
                                            {{ stats.profitable_trades }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Losing Trades</td>
                                        <td class="text-end text-danger">
                                            {{ stats.losing_trades }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Trades per Day</td>
                                        <td class="text-end">
                                            {{
                                            "{:.1f}".format(stats.trades_per_day)
                                            }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Total Volume</td>
                                        <td class="text-end">
                                            ${{
                                            "{:,.0f}".format(stats.total_volume)
                                            }}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Avg Trade Size</td>
                                        <td class="text-end">
                                            ${{
                                            "{:,.0f}".format(stats.avg_trade_size)
                                            }}
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <!-- Performance Rating -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <div
                                    class="alert {% if stats.profit_factor >= 1.5 and stats.win_rate >= 50 and stats.sharpe_ratio >= 1 %}alert-success{% elif stats.profit_factor >= 1 and stats.win_rate >= 40 %}alert-warning{% else %}alert-danger{% endif %} text-center"
                                >
                                    <h6 class="mb-1">
                                        {% if stats.profit_factor >= 1.5 and
                                        stats.win_rate >= 50 and
                                        stats.sharpe_ratio >= 1 %} üèÜ
                                        <strong>Excellent Performance</strong> -
                                        Strong risk-adjusted returns {% elif
                                        stats.profit_factor >= 1 and
                                        stats.win_rate >= 40 %} ‚ö°
                                        <strong>Good Performance</strong> -
                                        Solid trading with room for improvement
                                        {% else %} üî¥
                                        <strong>Needs Improvement</strong> -
                                        Consider reviewing strategy {% endif %}
                                    </h6>
                                    <small>
                                        Profit Factor: {{
                                        "{:.2f}".format(stats.profit_factor) }}
                                        | Win Rate: {{
                                        "{:.1f}%".format(stats.win_rate) }} |
                                        Sharpe: {{
                                        "{:.2f}".format(stats.sharpe_ratio) }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Render Portfolio PnL Chart
            Plotly.newPlot('pnlChart', {{ chart | safe }});

            // Render BTC Dollar Comparison Chart
            {% if btc_chart %}
            Plotly.newPlot('btcCompareChart', {{ btc_chart | safe }});
            {% endif %}

            // Render Percentage Returns Comparison Chart
            {% if percentage_chart %}
            Plotly.newPlot('percentageChart', {{ percentage_chart | safe }});
            {% endif %}

            // Render Drawdown Comparison Chart
            {% if drawdown_chart %}
            Plotly.newPlot('drawdownChart', {{ drawdown_chart | safe }});
            {% endif %}
        </script>
    </body>
</html>
